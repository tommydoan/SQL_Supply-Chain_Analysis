# Create forecast accuracy sale  in fiscal year 
#This included customer_code, customer name, market and showed the accuracy forecast % in specific fiscal_year

WITH CTE AS 
(SELECT 
    fiscal_year,
    product_code,
    f.customer_code,
    c.customer,
    c.market,
    SUM(sold_quantity) AS total_sold_quantity,
    SUM(forecast_quantity) AS total_forecast_quantity,
    SUM(forecast_quantity - sold_quantity) AS error,
    SUM(forecast_quantity - sold_quantity) * 100 / SUM(forecast_quantity) AS error_pct,
    ABS(SUM(forecast_quantity - sold_quantity)) AS ABS_error,
    ABS(SUM(forecast_quantity - sold_quantity)) * 100 / SUM(forecast_quantity) AS ABS_error_pct
FROM
    gdb0041.fact_forecast_sale_monthly f
        JOIN
    dim_customer c USING (customer_code)
GROUP BY fiscal_year , product_code , customer_code 
)
SELECT *,
	IF(ABS_error_pct > 100,0, 100-ABS_error_pct) AS accuracy_forecast_pct
FROM CTE 
WHERE fiscal_year = 2021
ORDER BY total_sold_quantity DESC

# Then, Create stored proceduces to adjust the fiscal year easily : 

CREATE DEFINER=`root`@`localhost` PROCEDURE `get_forecast_accuracy_FY`(
	In_fiscal_year INT		
)
BEGIN
WITH CTE AS 			
(SELECT 
    fiscal_year,
    product_code,
    f.customer_code,
    c.customer,
    c.market,
    SUM(sold_quantity) AS total_sold_quantity,
    SUM(forecast_quantity) AS total_forecast_quantity,
    SUM(forecast_quantity - sold_quantity) AS error,
    SUM(forecast_quantity - sold_quantity) * 100 / SUM(forecast_quantity) AS error_pct,
    ABS(SUM(forecast_quantity - sold_quantity)) AS ABS_error,
    ABS(SUM(forecast_quantity - sold_quantity)) * 100 / SUM(forecast_quantity) AS ABS_error_pct
FROM
    gdb0041.fact_forecast_sale_monthly f
        JOIN
    dim_customer c USING (customer_code)
GROUP BY fiscal_year , product_code , customer_code , sold_quantity , forecast_quantity 
)
SELECT *,
	IF(ABS_error_pct > 100,0, 100-ABS_error_pct) AS accuracy_forecast_pct
FROM CTE 
WHERE fiscal_year = In_fiscal_year
ORDER BY total_sold_quantity DESC;
END
-----



